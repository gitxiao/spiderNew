<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>永兴印刷订单生产管理系统-首页</title>
	<link rel="stylesheet" type="text/css" href="css/easyui/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="css/easyui/icon.css"/>
	<link rel="stylesheet" type="text/css" href="css/easyui/demo.css"/>
	<link rel="stylesheet" type="text/css" href="css/cf/table.css"/>
	<script type="text/javascript" src="js/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="js/easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="js/easyui/easyui-lang-zh_CN.js"></script>
	
	<script type="text/javascript" src="js/json2.js"></script>
	<script type="text/javascript" src="js/myNames.js"></script>
	<script type="text/javascript" src="js/myUtils.js"></script>
	<script type="text/javascript" src="js/myConstants.js"></script>
	<script>
		var toolbar = [{
			text:'查看详情',
			iconCls:'icon-search',
			handler:function(){scanForm();}
			},
			{text:'分配订单',
			iconCls:'icon-man',
			handler:function(){settleAccount();}
			}];
		var toolbar1 = [{
			text:'查看详情',
			iconCls:'icon-search',
			handler:function(){scanForm1();}
			},
			{text:'结束',
			iconCls:'icon-edit',
			handler:function(){openStopWin();}
			}];
		
		$(function(){
			getOrderFormData();			//加载订单数据
			getMakeListData();			//加载生产单数据
			
			getWorkersByDutyYS();		//加载印刷工数据
			getWorkersByDutyZD();		//加载印刷工数据
		});

		function scanForm(){
			//打开订单详情,读取选中的订单中的详细信息填充到dlg的表中
			var row = $("#dg").datagrid("getSelected");
			if(row){
			    fillContents("ddxq",row);
				$('#dlg').dialog('open');
			}else{
				$.messager.alert("操作提示","请选择要查看的订单");
			}
		}
		function settleAccount(){
			//打开分配订单
			var row = $("#dg").datagrid("getSelected");
			if(row){
				var allPageNum = row.productCount * row.pagination
				$("#fpformCode").html(row.formCode);
				$("#fpDdPageCount").html(allPageNum);					//订单页码数=单品页码数*产品数
				$("#fpScPageCount").html(allPageNum - row.remainPage);	//已生产页码数
				$("#fpUnAssignedNum").html(row.unAssignedNum);			//未分配页码数
				$('#spdlg2').dialog('open');
				
			}else{
				$.messager.alert("操作提示","请选择要分配的订单");
			}
		}
		//分配框中分配生产单
		function submitPrice1(){
			var row = $("#dg").datagrid("getSelected");
			
			var fpFpPageCount = $("#fpFpPageCount").textbox("getValue");	//分配数量
			var printerId = $('#fpYsWorker').combobox("getValue");			//印刷工id
			var bindId = $('#fpZdWorker').combobox("getValue");				//装订工id
			distribute(row,fpFpPageCount,printerId,bindId);
		}
		
		//分配操作,向服务器发送数据
		function distribute(row,count,printerId,bindId){
			if(!count){
				$.messager.alert("操作提示","请输入分配数量");
			}else if(!printerId){
				$.messager.alert("操作提示","请选择印刷工");
			}else if(!bindId){
				$.messager.alert("操作提示","请选择装订工");
			}else if(count > row.unAssignedNum){
				$.messager.alert("操作提示","分配数量不能大于未分配数!");
			}else if(count <= 0){
				$.messager.alert("操作提示","分配数量必须大于0!");
			}else{
				var data = "{\"fid\":\"" + row.id + 
							   "\",\"distributeDate\":\"" + row.formDate + 
							   "\",\"planPage\":\"" + count + 
							   "\",\"remainPage\":\"" + count +
							   "\",\"printerId\":\"" + printerId +
							   "\",\"bindId\":\"" + bindId + 
							   "\",\"isEnter\":0,\"remark\":\"" + "我是备注" +
							    "\"}";
				$.post(opertionUrl+"makelist/saveMakeList",{para:data,userId:getChildUserId()},distributeResult,"json");
			}
		}
		
		//分配结果处理
		function distributeResult(sresult){
			
			if(!sresult||sresult.sign==-2 ){
				$.messager.alert("提示","分配失败");
			}else{
				$.messager.alert("操作提示", "分配任务完成，请在生产单管理打印生产单");    
				$('#spdlg2').dialog('close');
				$('#dlg').dialog('close');
				getMakeListData();
				refreshOrderForm();
				//for(xx in oldData){
					//alert('xx = ' + xx);
				//}
				//$("#scdg").datagrid('appendRow',sresult);
				//editIndex = $('#scdg').datagrid('getData').total+1;
				//$("#scdg").datagrid('acceptChanges');
				//var oldData = $('#scdg').datagrid('getRows');
				//alert("oldData.length 1 = " + oldData.length);
				//alert("oldData.rows.length 1 = " + oldData.rows.length);
				
				/*oldData.rows.push(sresult);
				oldData.rows.unshift(sresult);
				alert("oldData.rows.length 2 = " + oldData.rows.length);
				oldData.total++;
				$("#scdg").datagrid({loadFilter:pagerFilter,loadMsg:'数据正在加载,请耐心的等待...',striped:true}).datagrid('loadData', oldData);
				*/
				
				//alert(oldData.length);
				//$('#scdg').datagrid('insertRow',{index:0,row:sresult}).datagrid('acceptChanges').datagrid({loadFilter:pagerFilter}).datagrid('reload');
				//$('#scdg').datagrid('insertRow',{index:0,row:sresult}).datagrid('acceptChanges').datagrid('reload');
				//$('#scdg').datagrid('appendRow',sresult).datagrid('acceptChanges');
				//$('#scdg').datagrid('reload');
			}
		}
		
		//提交生产单后更新订单列表
		function refreshOrderForm(){
			var row = $("#dg").datagrid("getSelected");
			var index = $('#dg').datagrid('getRowIndex', row);
            
            //不从服务器获取数据,修改后直接刷新
            var fpFpPageCount = $("#fpFpPageCount").textbox("getValue");	//分配数量
			row.unAssignedNum = row.unAssignedNum - fpFpPageCount
			row.stateName = getDistributeStateName(row.unAssignedNum,row.productCount * row.pagination);
			$('#dg').datagrid('refreshRow', index);	//刷新修改的那一行
			
			
			//从服务器重新获取数据后刷新
		    /*$.post(opertionUrl+"orderform/findOrderById",{id:row.id},function(jsdata){
				var data = eval(jsdata);
				alert("index = " + index + ", data[0].unAssignedNum = " + data[0].unAssignedNum);
				row.unAssignedNum = data[0].unAssignedNum
				row.stateName = data[0].stateName
            	$('#dg').datagrid('refreshRow', index);	//刷新修改的那一行
		    },"text");*/
		            
		    //刷新整个订单列表
			//getOrderFormData();					
		}
		
		//中断生产单, 中断后进入结束状态
		function openStopWin(){
			var row = $("#scdg").datagrid("getSelected");
			if(!row){
				$.messager.alert("操作提示","请选择要结束的生产单");
			}else if(row.stateSc == STATE_FINISHED){
				$.messager.alert("操作提示","此生产单已结束");
			}else if(row.stateSc == STATE_PRODUCING){
			   	$.messager.confirm("操作提示", "该生产单还没领料,确定要结束这个生产单？", function (data) {
					if (data) { 
						$.post(opertionUrl+"makelist/stopNoGetMakeListById",{id:row.id},stopMakeListResult,"text");
					}  
				});
			}else if(row.stateSc == STATE_GETPAPER){
				$("#jsdlg").dialog('open');
			}
		}
		function stopMakeList(){
			var row = $("#scdg").datagrid("getSelected");
			if(row){
				var id = row.id;
				var hadProductCount = $("#haveProductCount").textbox("getValue");
				var remainPaperCount =$("#remainPaper").textbox("getValue");
				$.post(opertionUrl+"makelist/stopMakeListById",{id:id,hadProductCount:hadProductCount,remainPaperCount:remainPaperCount},stopMakeListResult,"text");
			}  
		
		}
		
		function stopMakeListResult(sresult){
			if(sresult == "-1"){
				$.messager.alert("提示","操作失败");
			}else{
				$.messager.alert("提示","操作成功");
				$("#jsdlg").dialog('close');
				getOrderFormData();			//加载订单数据
				getMakeListData();	
				//var row = $("#scdg").datagrid("getSelected");
	           // var index = $('#scdg').datagrid('getRowIndex', row);
	           // row.stateScName = getMakeListStateName(row.stateSc);
	           // $('#scdg').datagrid('refreshRow', index);
			}
		}
		
		function scanForm1(){
			//打开生产单详情,读取选中的生产单中的详细信息填充到表中
			var row = $("#scdg").datagrid("getSelected");
			if(row){
			    fillContents("scdxq",row);
				$('#dlg1').dialog('open');
			}else{
				$.messager.alert("操作提示","请选择要查看的生产单");
			}
		}

		
		//填充订单表中的数据
		function loadOrderDataSuccess(jsdata){
			//$.messager.alert("操作提示",jsdata);
			var data = eval(jsdata); 
			$("#dg").datagrid({loadFilter:pagerFilter,loadMsg:'数据正在加载,请耐心的等待...',striped:true}).datagrid('loadData', data);
		}
		function getOrderFormData(){
			//从服务器获取订单数据
			$.post(opertionUrl+"orderform/findNoAssignedOverOrder",loadOrderDataSuccess,"text");
			//$.post(opertionUrl+"orderform/findOrderByState",{state:"2"},loadOrderDataSuccess,"text");
		}

		//填充生产表中的数据
		function loadMakeListSuccess(jsdata){
			$("#scdg").datagrid({loadFilter:pagerFilter,loadMsg:'数据正在加载,请耐心的等待...',striped:true}).datagrid('loadData', jsdata)
		}
		function getMakeListData(){
			$.post(opertionUrl+"makelist/findNoBreakMakeList",loadMakeListSuccess,"json");
		}
		
		
		//根据工种从服务器获取员工数据
		function getWorkersByDutyYS(){
			$.post(opertionUrl+"workerinfo/findWorkerByDuty",{para:DUTY_YSG},loadWorkersYsSuccess,"text");
		}
		function loadWorkersYsSuccess(jsondata){
			$("#fpYsWorker").combobox('loadData', eval(jsondata));
			$("#xqYsWorker").combobox('loadData', eval(jsondata));
		}
		function getWorkersByDutyZD(){
			$.post(opertionUrl+"workerinfo/findWorkerByDuty",{para:DUTY_ZDG},loadWorkersZdSuccess,"text");
		}
		function loadWorkersZdSuccess(jsondata){
			$("#fpZdWorker").combobox('loadData', eval(jsondata));
			$("#xqZdWorker").combobox('loadData', eval(jsondata));
		}
		
		
		function submitForm2(){
			var row = $("#dg").datagrid("getSelected");
			var fpPageCount = $("#xqFpPageCount").textbox("getValue");		//分配数量
			var printerId = $('#xqYsWorker').combobox("getValue");			//印刷工id
			var bindId = $('#xqZdWorker').combobox("getValue");				//装订工id
			distribute(row,fpPageCount,printerId,bindId);
		}
		function submitForm3(){
			$.messager.alert("操作提示", "打印生产单");    
		}
	</script>
</head>
<body>
	<div class="easyui-tabs" style="width:auto;height:auto;">
		<div title="订单分配" style="padding:10px">
			<table id="dg" style="width:780px;height:350px" data-options="
						rownumbers:true,
						singleSelect:true,
						autoRowHeight:false,
						pagination:true,
						pageSize:10,
						toolbar:toolbar">
				<thead>
					<tr>
						<th field="formCode" width="160">订单编号</th>
						<th field="cusName" width="100">客户名称</th>
						<th field="cusPhone" width="100">联系电话</th>
						<th field="expectDate" width="80" align="right">交货日期</th>
						<th field="printTypeName" width="40" align="right">工艺</th>
						<th field="pagination" width="60" align="right">单品页数</th>
						<th field="productCount" width="60">成品数量</th>
						<th field="producedNum" width="60">已生产数</th>
						<th field="stateName" width="60">订单状态</th>
						<th field="unAssignedNum" width="60">未分配数</th>
					</tr>
				</thead>
			</table>
			<div id="spdlg2" class="easyui-dialog" title="订单分配" data-options="iconCls:'icon-save',closed:true" style="width:320px;height:320px;padding:10px">
				<form id="ff4" method="post">
					<table cellpadding="5" width="100%">
						<tr>
							<td>订单编号:</td>
							<td id="fpformCode">YXYS20160309001</td>
						</tr>
						<tr>
							<td>总页码数:</td>
							<td id="fpDdPageCount">0</td>
						</tr>
						<tr>
							<td>已生产页码数:</td>
							<td id="fpScPageCount">0</td>
						</tr>
						<tr>
							<td>未分配页码数:</td>
							<td id="fpUnAssignedNum">0</td>
						</tr>
						<tr>
							<td>分配页码数:</td>
							<td ><input id="fpFpPageCount" class="easyui-numberbox" type="text" name="name" data-options="required:true"></input></td>
						</tr>
						<tr>
							<td>印刷工:</td>
							<td>
								<select id="fpYsWorker" class="easyui-combobox" name="印刷工" style="width:140px;" 
										data-options="
											required:true,
											editable:false,
											valueField:'id',
											textField:'wname' ">
								</select>
							</td>
						</tr>
						<tr>
							<td>装订工:</td>
							<td>
								<select id="fpZdWorker" class="easyui-combobox" name="装订工" style="width:140px;" 
										data-options="
											required:true,
											editable:false,
											valueField:'id',
											textField:'wname' ">
								</select>
							</td>
						</tr>
					</table>
				</form>
				<div style="text-align:center;padding:5px">
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitPrice1()">分配</a>
				</div>
			</div>
			<div id="dlg" class="easyui-dialog" title="订单详情" data-options="iconCls:'icon-save',closed:true" style="width:800px;height:500px;padding:10px">
				<form id="ff2" method="post">
					<table class="tablecss" >
						<tr>
							<th colspan="6" align="center">永兴印刷订单详情</th>
						</tr>
						<tr>
							<td>订单编号:</td>
							<td id="ddxqformCode" name="ddxq"></td>
							<td>接单时间:</td>
							<td id="ddxqformDate" name="ddxq"></td>
							<td>交货时间:</td>
							<td id="ddxqexpectDate" name="ddxq"></td>
						</tr>
						<tr>
							<td>客户名称:</td>
							<td id="ddxqcusName" name="ddxq"></td>
							<td>联系电话:</td>
							<td id="ddxqcusPhone" name="ddxq"></td>
							<td>产品名称:</td>
							<td id="ddxqproductName" name="ddxq"></td>
						</tr>
						<tr>
							<td>成品尺寸:</td>
							<td id="ddxqproductSize" name="ddxq"></td>
							<td>印刷工艺:</td>
							<td id="ddxqprintTypeName" name="ddxq"></td>
							<td>装订方式:</td>
							<td id="ddxqbindTypeName" name="ddxq"></td>
						</tr>
						<tr>
							<td>纸张规格:</td>
							<td id="ddxqpaperDetail" name="ddxq"></td>
							<td>设计师:</td>
							<td id="ddxqdesigner" name="ddxq"></td>
							<td>出版地:</td>
							<td id="ddxqprintFrom" name="ddxq"></td>
						</tr>
						<tr>
							<td>内资备案号:</td>
							<td id="ddxqbakCode" name="ddxq"></td>
							<td>小样备案号:</td>
							<td id="ddxqdemoCode" name="ddxq"></td>
							<td>加工类型:</td>
							<td id="ddxqmakeTypeName" name="ddxq"></td>
						</tr>
						<tr>
							<td>成品数:</td>
							<td id="ddxqproductCount" name="ddxq"></td>
							<td>单品页码数:</td>
							<td id="ddxqpagination" name="ddxq"></td>
							<td>备注:</td>
							<td id="ddxqremark" name="ddxq"></td>
						</tr>
						<tr>
							<td>已生产页码数:</td>
							<td id="ddxqproducedNum" name="ddxq"></td>
							<td>总页码数：</td>
							<td id="ddxqallPageNum" name="ddxq"></td>
							<td>未分配页码数：</td>
							<td id="ddxqunAssignedNum" name="ddxq"></td>
						</tr>
						<tr>
							<td>分配页码数:</td>
							<td><input id="xqFpPageCount" class="easyui-numberbox" type="text" name="name" /></td>
							<td>印刷工</td>
							<td>
								<select id="xqYsWorker" class="easyui-combobox" style="width:140px;"
										data-options="
											required:true,
											editable:false,
											valueField:'id',
											textField:'wname' ">
									
								</select>
							</td>							
							<td>装订工:</td>
							<td>
								<select id="xqZdWorker" class="easyui-combobox" name="领料人" style="width:140px;"
										data-options="
											required:true,
											editable:false,
											valueField:'id',
											textField:'wname' ">
								</select>
							</td>
						</tr>
						
					</table>
				</form>
				<div style="text-align:center;padding:5px">
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm2()">分配</a>
				</div>
			</div>
			<div id="dlg1" class="easyui-dialog" title="生产单详情" data-options="iconCls:'icon-save',closed:true" style="width:800px;height:700px;padding:10px">
				<form id="ff2" method="post">
					<table class="tablecss" >
						<tr>
							<th colspan="6" align="center">永兴印刷生产单详情</th>
						</tr>
						<tr>
							<td>生产单编号</td>
							<td id="scdxqmakeCode" name="scdxq" colspan="5" align="center"></td>
						</tr>
						<tr>
							<td>订单编号:</td>
							<td id="scdxqformCode" name="scdxq"></td>
							<td>时间:</td>
							<td id="scdxqformDate" name="scdxq"></td>
							<td>客户名称:</td>
							<td id="scdxqcusName" name="scdxq"></td>
						</tr>
						<tr>
							<td>联系电话:</td>
							<td id="scdxqcusPhone" name="scdxq"></td>
							<td>印刷品名称:</td>
							<td id="scdxqproductName" name="scdxq"></td>
							<td>纸张规格:</td>
							<td id="scdxqpaperDetail" name="scdxq"></td>
						</tr>
						<tr>
							<td>印刷工艺:</td>
							<td id="scdxqprintTypeName" name="scdxq"></td>
							<td>装订方式:</td>
							<td id="scdxqbindTypeName" name="scdxq"></td>
							<td>交货时间:</td>
							<td id="scdxqexpectDate" name="scdxq"></td>
						</tr>
						<tr>
							<td>设计师:</td>
							<td id="scdxqdesigner" name="scdxq"></td>
							<td>出版地:</td>
							<td id="scdxqprintFrom" name="scdxq"></td>
							<td>内资备案号:</td>
							<td id="scdxqbakCode" name="scdxq"></td>
						</tr>
						<tr>
							<td>小样备案号:</td>
							<td id="scdxqdemoCode" name="scdxq"></td>
							<td>总数量：</td>
							<td id="scdxqplanPage" name="scdxq"></td>
							<td>加工类型:</td>
							<td id="scdxqmakeTypeName" name="scdxq"></td>
						</tr>
						<tr>
							<td>成品尺寸:</td>
							<td id="scdxqproductSize" name="scdxq"></td>
							<td>印刷工</td>
							<td id="scdxqprinterName" name="scdxq"></td>							
							<td>装订工:</td>
							<td id="scdxqbinderName" name="scdxq"></td>
						</tr>
						<tr style="height:60px">
							<td>领料详情</td>
							<td id="scdxqll"" colspan="3" align="center"></td>
							<td>签字</td>
							<td></td>
						</tr>
						<tr style="height:60px">
							<td>印刷详情</td>
							<td id="scdxqys" colspan="3" align="center"></td>
							<td>签字</td>
							<td></td>
						</tr>
						<tr style="height:60px">
							<td>装订详情</td>
							<td id="scdxqzd" colspan="3" align="center"></td>
							<td>签字</td>
							<td></td>
						</tr>
						<tr style="height:60px">
							<td>产品入库详情</td>
							<td id="scdxqrk" colspan="3" align="center"></td>
							<td>签字</td>
							<td></td>
						</tr>
						
					</table>
				</form>
				<div style="text-align:center;padding:5px">
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm3()">打印</a>
				</div>
			</div>
			
		</div>
		<div title="生产单管理" style="padding:10px;">
			<table id="scdg" style="width:850px;height:350px" data-options="
						rownumbers:true,
						singleSelect:true,
						autoRowHeight:false,
						pagination:true,
						pageSize:10,
						toolbar:toolbar1">
				<thead>
					<tr>
						<th field="makeCode" width="160">生产单编号</th>
						<th field="formCode" width="160">订单编号</th>
						<th field="cusName" width="150">客户名称</th>
						<th field="cusPhone" width="100">联系电话</th>
						<th field="expectDate" width="80" align="right">交货日期</th>
						<th field="printTypeName" width="40" align="right">工艺</th>
						<th field="planPage" width="60" align="right">安排数量</th>
						<th field="stateScName" width="60">状态</th>
					</tr>
				</thead>
			</table>
			<div id="jsdlg" class="easyui-dialog" title="结束生产单" data-options="iconCls:'icon-save',closed:true" style="width:300px;height:200px;padding:10px">
				<form id="ff4" method="post">
					<table cellpadding="5">
						
						<tr>
							<td>已生产页码数:</td>
							<td><input id="haveProductCount" class="easyui-numberbox" type="text" data-options="required:true"></input></td>
						</tr>
						<tr>
							<td>剩余纸张:</td>
							<td><input id="remainPaper" class="easyui-numberbox" type="text" data-options="required:true"></input></td>
						</tr>
					</table>
				</form>
				<div style="text-align:center;padding:5px">
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="stopMakeList()">结束</a>
				</div>
			</div>
		</div>
	</div>
</body>
</html>