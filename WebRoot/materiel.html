<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>永兴印刷订单生产管理系统-物料管理</title>
	<link rel="stylesheet" type="text/css" href="css/easyui/easyui.css" />
	<link rel="stylesheet" type="text/css" href="css/easyui/icon.css" />
	<link rel="stylesheet" type="text/css" href="css/easyui/demo.css" />
	<link rel="stylesheet" type="text/css" href="css/cf/table.css" />
	<script type="text/javascript" src="js/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="js/easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="js/easyui/easyui-lang-zh_CN.js"></script>
	
	<script type="text/javascript" src="js/myConstants.js"></script>
	<script type="text/javascript" src="js/myUtils.js"></script>
	<script type="text/javascript" src="js/myNames.js"></script>
	<script>
		$(function(){
			//出库单初始化
			setCkFormCode();
			loadProductForm();
			loadGetPerson();
			loadOutPerson();
			//入库单初始化
			setRkFormCode();
			loadNoBuyForm();
			
			//库存信息初始化
			getCLData();		//先从材料类型表中拿出所有的材料类型数据
		});
		
		
		//加载库存信息
		function fillClData(materialData){
			$("#kcdg").datagrid({loadFilter:pagerFilter,loadMsg:'数据正在加载,请耐心的等待...',striped:true}).datagrid('loadData', materialData)
		}
		function getCLData(){
			//从服务器获取材料数据
			$.post(opertionUrl+"material/findAllMaterialType",fillClData,"json");
		}
		
		function loadGetPerson(){
			$.post(opertionUrl+"workerinfo/findWorkerByDuty",{para:DUTY_YSG},loadGetPersonSuccess,"json");
		}
		
		function loadGetPersonSuccess(data){
			$("#getPersonId").combobox('loadData', data)
		}
		
		function loadOutPerson(){
			$.post(opertionUrl+"workerinfo/findWorkerByDuty",{para:DUTY_KG},loadOutPersonSuccess,"json");
		}
		
		function loadOutPersonSuccess(data){
			$("#outPersonId").combobox('loadData', data);
			$("#enterPersonId").combobox('loadData', data)
		}
		
		function setCkFormCode(){
			$.post(opertionUrl+"materialOut/nextCkFormCode",loadCkNextCodeSuccess,"text");
		}
		function loadCkNextCodeSuccess(data){
			$("#ckformCode").html(data);
		}
		
		function loadProductForm(){
			$.post(opertionUrl+"makelist/findMakeListByState",{state:0},loadMakeListSuccess,"json");
		}
		function loadMakeListSuccess(data){
			$("#productFormCode").combobox('loadData', data);
		}
		function loadDetailProductForm(){
			var fid = $("#productFormCode").combobox('getValue');
			$.post(opertionUrl+"makelist/findDetailMakeListById",{id:fid},loadDetailMakeListSuccess,"json");
			
		}
		function loadDetailMakeListSuccess(data){
			$("#planCount").html("100"); //需要计算数量
			$("#paperDetail").html(data.paperDetail);
			$("#paperId").val(data.paperId);
			getMaterialCount(data.paperId);
		}
		
		function getMaterialCount(mid){
			$.post(opertionUrl+"materialList/getMCountByMid",{mid:mid},loadMaterialCountSuccess,"text");
		}
		function loadMaterialCountSuccess(data){
			$("#totalCount").html(data);
		}
		
		function submitMOForm(){
			var para ='{"outCode":"'+$("#ckformCode").text()+'","mid":'+$("#paperId").val()+',"makeId":'+$("#productFormCode").combobox('getValue')+',"getPersonId":'+$("#getPersonId").combobox('getValue')+',"outPersonId":'+$("#outPersonId").combobox('getValue')+',"getCount":'+$("#paperCount").textbox("getValue")+'}';
			$.post(opertionUrl+"materialOut/saveMoForm",{para:para},saveMoFormSuccess,"text");
		}
		
		function saveMoFormSuccess(data){
			if(data=='-2'){
				$.messager.alert("操作提示","领料失败");
			}else{
				getCLData();		//领料成功后刷新库存数据
				$.messager.alert("操作提示","领料成功");
				clear();
			}
		}
		function clear(){
			setCkFormCode();
			$("#planCount").html(""); //需要计算数量
			$("#paperDetail").html("");
			$("#getPersonId").combobox('unselect', $("#getPersonId").combobox("getValue"));
			$("#outPersonId").combobox('unselect', $("#outPersonId").combobox("getValue"));
			$("#totalCount").html("");
			$("#paperCount").textbox("setValue","")
			loadProductForm();
			
		}
		/********************************************************************材料出库单结束************************************************************/
		function setRkFormCode(){
			$.post(opertionUrl+"materialEnter/nextRkFormCode",loadRkNextCodeSuccess,"text");
		}
		function loadRkNextCodeSuccess(data){
			$("#rkformCode").html(data);
		}
		function loadNoBuyForm(){
			$.post(opertionUrl+"buyform/getBuyFormByState",{state:0},loadNoBuyFormSuccess,"json");
		}
		function loadNoBuyFormSuccess(data){
			//alert(data);
			//printObject(data,'data');
			$("#buyFormBox").combobox('loadData', data);
		}
		
		function getDetailBuyForm(){
			var pid = $("#buyFormBox").combobox("getValue");
			$.post(opertionUrl+"buyform/getDetailBuyFormById",{id:pid},loadDetailBuyFormSuccess,"json");
		}
		function loadDetailBuyFormSuccess(data){
			if(data){
				$("#materialName").html(data.materialName);
				$("#materialSize").html(data.materialSize);
				$("#buyCount").html(data.mcount);
				$("#supplierName").html(data.supplierName);
				$("#buyPersonName").html(data.buyPersonName);
				$("#supplierId").val(data.supid);
				$("#buyformId").val(data.id);
				$("#mtype").val(data.mtype);
				$("#mid").val(data.mid);
			}
			
		}
		function submitMIForm(){
			var para = '{"menterCode":"'+$("#rkformCode").text()+'","bid":'+$("#buyformId").val()+',"enterMtype":'+$("#mtype").val()+
				',"enterMid":'+$("#mid").val()+',"enterCount":'+$("#enterCount").textbox("getValue")+',"enterPersonId":'+$("#enterPersonId").combobox("getValue")
				+',"supId":'+$("#supplierId").val()+'}';
			$.post(opertionUrl+"materialEnter/saveEnterForm",{para:para},saveEnterFormSuccess,"text");
		}
		function saveEnterFormSuccess(data){
			if(data=='-2'){
				$.messager.alert("操作提示","入库失败");
			}else{
				$.messager.alert("操作提示","入库成功");
				clearRk();
			}
		}
		
		function clearRk(){
			setRkFormCode();			
			$("#materialName").html("");
			$("#materialSize").html("");
			$("#buyCount").html("");
			$("#supplierName").html("");
			$("#buyPersonName").html("");
			$("#supplierId").val("");
			$("#buyformId").val("");
			$("#mtype").val("");
			$("#mid").val("");
			$("#buyFormBox").combobox('unselect', $("#buyFormBox").combobox("getValue"));
			$("#enterPersonId").combobox('unselect', $("#enterPersonId").combobox("getValue"));
			$("#enterCount").textbox("setValue","");
			loadNoBuyForm();
		}
		/**********************************************************************************入库结束************************************************************/
	</script>
</head>
<body>
	<div class="easyui-tabs" style="width:auto;height:auto;">
		<div title="原材料出库" style="padding:10px">
			<div style="padding:10px 60px 20px 60px">
				<form id="miff" method="post">
					<table class="tablecss" style="width:800px;">
						<tr>
							<th colspan="6" align="center">永兴印刷原材料出库单</th>
						</tr>
						<tr>
							<td>出库单编号:</td>
							<td id="ckformCode"></td>
							<td>生产单编号:</td>
							<td><input id="productFormCode" class="easyui-combobox" style="width: 200px;" data-options="valueField:'id',textField:'makeCode',onSelect:loadDetailProductForm" /></td>
						</tr>
						<tr>
							<td>材料名称:</td>
							<td id="paperDetail"></td>
							<td>建议纸张数量:</td>
							<td id="planCount"></td>
						</tr>
						<tr>
							<td>库存数量:</td>
							<td id="totalCount"></td>
							<td>领取数量:</td>
							<td>
								<input id="paperCount" class="easyui-numberbox" type="text" name="paperCount" />
								<input id="paperId" type="hidden"/>
							</td>
							
						</tr>
						<tr>
							<td>领料人:</td>
							<td><input id="getPersonId" class="easyui-combobox" data-options="valueField:'id',textField:'wname'" /></td>
							<td>出库人:</td>
							<td ><input id="outPersonId" class="easyui-combobox" data-options="valueField:'id',textField:'wname'" /></td>
						</tr>
						<tr>
							<td colspan="4" align="center">
								<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitMOForm()">提交</a>
							</td>
						</tr>
						
					</table>
				</form>
			</div>
		</div>
		<div title="原材料入库" style="padding:10px;">
			<div style="padding:10px 60px 20px 60px">
				<form id="miff" method="post">
					<table class="tablecss" style="width:800px;">
						<tr>
							<th colspan="6" align="center">永兴印刷原材料入库单</th>
						</tr>
						<tr>
							<td>入库单编号: <input id="buyformId" type="hidden" /></td>
							<td id="rkformCode"></td>
							<td>采购单编号:</td>
							<td><input id="buyFormBox" class="easyui-combobox" data-options="valueField:'id',textField:'buyFormCode',onSelect:getDetailBuyForm" /></td>
						</tr>
						<tr>
							<td>材料名称: <input id="mtype" type="hidden" /></td>
							<td id="materialName"></td>
							<td>规格型号:<input id="mid" type="hidden" /></td>
							<td id="materialSize"></td>
						</tr>
						<tr>
							<td>采购数量:</td>
							<td id="buyCount"></td>
							<td>供应商:<input id="supplierId" type="hidden" /></td>
							<td id="supplierName"> </td>
						</tr>
						<tr>
							<td>采购人:</td>
							<td id="buyPersonName"></td>
							<td>入库数量:</td>
							<td><input id="enterCount" class="easyui-numberbox" type="text" /></td>
						</tr>
						<tr>
							<td>入库人:</td>
							<td colspan="3"><input id="enterPersonId" class="easyui-combobox" data-options="valueField:'id',textField:'wname'" /></td>
						</tr>
						<tr>
							<td colspan="4" align="center">
								<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitMIForm()">提交</a>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
		<div title="库存信息" style="padding:10px;">
			<!--<div class="easyui-panel" style="padding:5px;width:780px;">
				<span style="padding:3px 5px 3px 10px;">原材料类型：</span>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g1',selected:true" style="margin:3px 5px 3px 10px;">全部</a>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g1'" style="margin:3px 5px 3px 10px;">纸张</a>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g1'" style="margin:3px 5px 3px 10px;">油墨</a>
				<span style="padding:3px 5px 3px 200px;">使用状态：</span>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g2'" style="margin:3px 5px 3px 10px;">全部</a>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g2',selected:true" style="margin:3px 5px 3px 10px;">在用</a>
				<a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g2'" style="margin:3px 5px 3px 10px;">停用</a>
			</div>

			--><table id="kcdg" style="width:780px;height:350px" data-options="
						rownumbers:true,
						singleSelect:true,
						autoRowHeight:false,
						pagination:true,
						pageSize:10 ">
				<thead>
					<tr>
						<th field="mtypename" width="120">原材料类型</th>
						<th field="mname" width="120">原材料名称</th>
						<th field="msize" width="100">规格参数</th>
						<th field="munit" width="80" align="right">计量单位</th>
						<th field="count" width="80" align="right">库存数量</th>
						<!--<th field="clcustomer" width="80" align="right">供货商</th>
						<th field="clstate" width="80" align="right">使用状态</th>-->
					</tr>
				</thead>
			</table>
		</div>
	</div>
</body>
</html>